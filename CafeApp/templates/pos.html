<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - Cafe Vip Pro</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
      .fee-left{
  display: inline-flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}


.sum-money{
  text-align:right;
  min-width: 90px;   /* ƒë·ªß ƒë·ªÉ canh th·∫≥ng h√†ng ti·ªÅn */
}


        #taxCheck{
  vertical-align: middle;
  margin-top: 0px;
}

        /* ===== Service fee input (POS style) ===== */
.fee-input{
  width:48px;
  height:22px;
  padding:2px 4px;
  font-size:13px;
  text-align:right;
  border:1px solid #ccc;
  border-radius:6px;
  outline:none;
}

.fee-input:focus{
  border-color:#28a745;
  box-shadow:0 0 0 1px rgba(40,167,69,.2);
}

/* ·∫®n spinner n·∫øu browser v·∫´n render */
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{
  -webkit-appearance:none;
  margin:0;
}
input[type=number]{
  -moz-appearance:textfield;
}

  .cart-area { background:#fff; border-left:1px solid #ddd; height: calc(100vh - 50px); }
  .inv-top { padding:10px 12px; border-bottom:1px solid #eee; background:#fff; }
  .inv-title { font-weight:900; font-size:18px; text-align:center; margin:0; }
  .inv-code { font-weight:800; color:#28a745; }

  .seg-tabs { display:flex; gap:8px; padding:10px 12px; border-bottom:1px solid #eee; background:#f8f9fa; }
  .seg-btn{
    flex:1; text-align:center; font-size:14px; padding:10px 6px;
    border:1px solid #ddd; border-radius:10px; cursor:pointer; background:#fff;
  }
  .seg-btn.active{ background:#28a745; border-color:#28a745; color:#fff; font-weight:800; }

  .inv-items-wrap{
  flex: 1 1 auto;
  min-height: 0;   /* quan tr·ªçng ƒë·ªÉ scroll ho·∫°t ƒë·ªông trong flex */
  overflow: hidden;
}
  .inv-items-box{
    border:1px solid #eee; border-radius:12px; overflow:hidden;
    background:#fff;
  }
  .inv-items-head{ background:#f3f4f6; padding:8px 10px; font-weight:800; font-size:13px; }
  .inv-items-body{
  height: 100%;
  max-height: none;
  overflow-y: auto;
}
  .table-cart th { font-size:12px; padding:8px; background:#f3f4f6; }
  .table-cart td { font-size:13px; padding:10px 8px; vertical-align:middle; }

  .inv-sum{
  flex: 0 0 auto;
  padding: 10px 12px;
  background:#fff;
  border-top: 1px solid #eee;
}
  .sum-row{ display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;   /* ‚Üì */
  font-size:13px;    }
  .sum-row strong{ font-weight:900; }
  .sum-total{
    display:flex; justify-content:space-between; align-items:center;
      padding:6px 10px;    /* ‚Üì */
  margin:6px 0;        /* ‚Üì */
  border-radius:10px;
    background:#fff3e6; border:1px solid #ffe0c2;

  }
  .sum-total .label{ font-weight:900; font-size:13px; }
  .sum-total .value{ font-weight:900; font-size:20px;  color:#d0021b; }

 .inv-actions{
  flex: 0 0 auto;
  padding: 6px 10px;
  background:#fff;
  border-top: 1px solid #eee;
}
  .btn-pay { width:100%; background:#fd7e14; color:#fff; font-weight:900; border-radius:12px; padding:8px; border:none; font-size:14px; }
  .btn-pay:hover{ background:#e96b02; }
  .btn-soft{ border-radius:12px; }
        .customer-box{
  border:1px solid #e9ecef;
  border-radius:10px;
  background:#fff;
  padding:6px 8px;        /* ‚Üì gi·∫£m m·∫°nh */
  font-size:13px;
}

.customer-box .text-muted{
  font-size:11px;
}

.customer-box .btn{
  padding:3px 8px;
  font-size:12px;
}

    </style>


    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; overflow: hidden; }

        /*  HEADER */
        .pos-header { background-color: #28a745; color: white; padding: 0 15px; height: 50px; display: flex; align-items: center; justify-content: space-between; }

        .header-logo { font-weight: bold; font-size: 20px; margin-right: 20px; display: flex; align-items: center; }

        .header-btn { color: white; background: transparent; border: none; padding: 5px 15px; font-weight: 600; font-size: 14px; }
        .header-btn:hover, .header-btn.active { background-color: rgba(255,255,255,0.2); border-radius: 4px;}
        .header-icon { font-size: 18px; margin-left: 15px; cursor: pointer; }

        /*  CATEGORY TABS  */
        .cat-bar { background: white; padding: 5px 10px; border-bottom: 1px solid #ddd; white-space: nowrap; overflow-x: auto; }
        .cat-btn { border: 1px solid #eee; background: #fff; padding: 5px 15px; border-radius: 4px; margin-right: 5px; font-size: 13px; color: #333; }

        /* Active Tab */
        .cat-btn.active { background-color: #28a745; color: white; border-color: #28a745; }

        /*  PRODUCT GRID  */
        .product-area { height: calc(100vh - 100px); overflow-y: auto; padding: 10px; transition: all 0.3s; }
        .product-card {
            background: white; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer; overflow: hidden; position: relative; height: 120px; margin-bottom: 10px;
        }
        .product-card:hover { border: 1px solid #28a745; }
        .p-img { width: 100%; height: 70px; object-fit: cover; }
        .p-price-tag {
            position: absolute; top: 0; right: 0;
            background-color: #28a745; color: white;
            font-size: 12px; padding: 2px 6px;
            border-bottom-left-radius: 5px;
        }
        .p-name { font-size: 13px; font-weight: 600; padding: 5px; line-height: 1.2; text-align: center; color: #333; }

        /*  CART SIDEBAR  */
        .cart-area{
  height: calc(100vh - 56px); /* n·∫øu header cao kh√°c th√¨ ch·ªânh 56px */
  display:flex;
  flex-direction:column;
  overflow:hidden; /* quan tr·ªçng: ch·∫∑n ƒë·∫©y xu·ªëng */
}

        /* Order Tabs */
        .order-tabs { display: flex; border-bottom: 1px solid #ddd; padding: 5px; background: #f8f9fa; }
        .order-tab-btn {
            flex: 1; text-align: center; font-size: 13px; padding: 5px;
            border: 1px solid transparent; cursor: pointer; color: #555;
        }
        .order-tab-btn.active { background: #28a745; color: white; border-radius: 3px; }

        /* Cart List */
        .cart-list { flex: 1; overflow-y: auto; padding: 0; }
        .table-cart th { font-size: 12px; background: #eee; padding: 5px; }
        .table-cart td { font-size: 13px; padding: 8px 5px; vertical-align: middle; }
        .btn-qty { padding: 0 5px; font-size: 12px; border: 1px solid #ddd; background: #fff; }

        /* Cart Footer */
        .cart-footer { padding: 10px; background: #f8f9fa; border-top: 1px solid #ddd; }
        .fee-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 5px; }

        .btn-pay { width: 100%; background-color: #fd7e14; color: white; font-weight: bold; padding: 10px; border: none; font-size: 16px; }
        .btn-pay:hover { background-color: #e96b02; }

        /*  LAYOUT CONTROL  */
        .layout-full .col-left { flex: 0 0 100%; max-width: 100%; }
        .layout-split .col-left { flex: 0 0 66.66%; max-width: 66.66%; }
        .layout-split .cart-area { display: flex; flex: 0 0 33.33%; max-width: 33.33%; }

    </style>
</head>
<body>

<div class="pos-header">
    <div class="d-flex align-items-center">
        <div class="header-logo">
            <i class="fas fa-leaf mr-2"></i> CAFE VIP PRO
        </div>

        <button class="header-btn active"><i class="fas fa-utensils"></i> Order Online</button>
        <button class="header-btn"><i class="fas fa-truck"></i> S·ªë giao h√†ng</button>
    </div>
    <div class="d-flex align-items-center">
        <span class="mr-3"><i class="fas fa-user"></i> {{ current_user.name }}</span>
        <i class="fas fa-sync header-icon" title="ƒê·ªìng b·ªô"></i>
        <i class="fas fa-cloud header-icon" title="ƒê√°m m√¢y"></i>
        <div class="dropdown">
            <i class="fas fa-bars header-icon dropdown-toggle"
               id="posMenu"
               data-toggle="dropdown"
               aria-haspopup="true"
               aria-expanded="false"
               style="cursor:pointer">
            </i>

            <div class="dropdown-menu dropdown-menu-right">
                <a class="dropdown-item" href="{{ url_for('order_history') }}">
                    <i class="fas fa-receipt mr-2"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng
                </a>

                <div class="dropdown-divider"></div>

                <a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt mr-2"></i> ƒêƒÉng xu·∫•t
                </a>
            </div>
        </div>
    </div>
</div>


<div class="container-fluid p-0">
    <div id="mainLayout"
         class="row no-gutters {% if pos_cart and pos_cart|length > 0 or modal_ctx %}layout-split{% else %}layout-full{% endif %}">

        <div class="col-12 col-left">
            <div class="cat-bar">
                <button class="cat-btn active">T·∫•t c·∫£</button>
                <button class="cat-btn">C√† ph√™</button>
                <button class="cat-btn">Tr√†</button>
                <button class="cat-btn">B√°nh ng·ªçt</button>
                <button class="cat-btn">Kh√°c</button>

                <div style="display:inline-block; float:right; width: 300px;">
                    <input type="text" class="form-control form-control-sm" placeholder="T√¨m m√≥n (F3)...">
                </div>
            </div>

            <div class="product-area">
                <div class="row px-2">
                    {% for item in items %}
                    <div class="col-6 col-md-3 col-lg-2 px-1">
                        <a href="{{ url_for('pos_page', page=page, mon_id=item.id) }}"
                           class="text-decoration-none text-dark">

                            <div class="product-card"
                            >
                                <div class="p-price-tag">{{ "{:,.0f}".format(item.gia) }}</div>

                                {% if item.image %}
                                <img src="{{ url_for('static', filename='img/' + item.image) }}" class="p-img"
                                     alt="{{ item.name }}">
                                {% else %}
                                <img src="https://via.placeholder.com/150?text={{ item.name[:2] }}" class="p-img">
                                {% endif %}

                                <div class="p-name">{{ item.name }}</div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                <div class="pos-pagination d-flex justify-content-center">
                    {% if pages > 1 %}
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('pos_page', page=page-1) }}">¬´</a>
                            </li>

                            {% for p in range(1, pages + 1) %}
                            <li class="page-item {% if p == page %}active{% endif %}">
                                <a class="page-link" href="{{ url_for('pos_page', page=p) }}">{{ p }}</a>
                            </li>
                            {% endfor %}

                            <li class="page-item {% if page >= pages %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('pos_page', page=page+1) }}">¬ª</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>

            </div>


        </div>

        <div class="cart-area d-flex flex-column">

            <!-- Title center -->
            <div class="inv-top">
                <p class="inv-title">
                    H√ìA ƒê∆†N
                </p>
            </div>

            <!-- Lo·∫°i h√≥a ƒë∆°n -->
            <div class="seg-tabs">
                <div class="seg-btn active" onclick="setOrderType('TAI_QUAN', this)">
                    <i class="fas fa-chair mr-1"></i> T·∫°i qu√°n
                </div>
                <div class="seg-btn" onclick="setOrderType('MANG_DI', this)">
                    <i class="fas fa-shopping-bag mr-1"></i> Mang ƒëi
                </div>
            </div>

            <!-- Items box (PH·∫¶N N√ÄY S·∫º CU·ªòN) -->
            <div class="inv-items-wrap flex-grow-1" style="min-height:0; overflow:hidden;">
                <div class="inv-items-box h-100 d-flex flex-column">
                    <div class="inv-items-head">Danh s√°ch m√≥n</div>

                    <div class="inv-items-body flex-grow-1" style="overflow-y:auto;">
                        <table class="table table-sm table-cart mb-0">
                            <thead>
                            <tr>
                                <th style="width:52%">T√™n m√≥n</th>
                                <th style="width:22%">SL</th>
                                <th class="text-right">Ti·ªÅn</th>
                                <th style="width:6%"></th>
                            </tr>
                            </thead>

                            <!-- QUAN TR·ªåNG: tbody id n√†y ph·∫£i kh·ªõp JS -->
                            <tbody id="cartTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Summary (N·∫∞M Y√äN ·ªû D∆Ø·ªöI) -->
            <div class="inv-sum mt-2">
                <!-- KH√ÅCH H√ÄNG (server-side, kh√¥ng JS) -->
                <div class="customer-box d-flex align-items-center justify-content-between mb-1">

                    <div class="d-flex align-items-center">
                        <span style="font-size:18px;margin-right:8px;">üë§</span>
                        <div>
                            <div class="text-muted" style="font-size:12px;line-height:1;">Kh√°ch h√†ng</div>

                            {% set cust = session.get('pos_customer') %}
                            {% if cust and cust.get('phone') %}
                            <div class="font-weight-bold" style="font-size:14px;">
                                {{ cust.get('name') or 'Kh√°ch' }} - {{ cust.get('phone') }}
                            </div>
                            {% else %}
                            <div class="font-weight-bold" style="font-size:14px;">
                                Ch∆∞a c√≥ th√¥ng tin
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="d-flex" style="gap:8px;">

                        {% if cust and cust.get('phone') %}
                        {# === ƒê√É C√ì KH√ÅCH ‚Üí CH·ªàNH S·ª¨A === #}
                        <a class="btn btn-sm btn-outline-success"
                           href="{{ url_for('pos_page', page=page, customer_modal=1) }}">
                            <i class="fas fa-edit mr-1"></i> Ch·ªânh s·ª≠a
                        </a>

                        <form method="post" action="{{ url_for('pos_customer_clear') }}" class="m-0">
                            <input type="hidden" name="page" value="{{ page }}">
                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash mr-1"></i> X√≥a
                            </button>
                        </form>

                        {% else %}
                        {# === CH∆ØA C√ì KH√ÅCH ‚Üí TH√äM TH√îNG TIN === #}
                        <a class="btn btn-sm btn-outline-success"
                           href="{{ url_for('pos_page', page=page, customer_modal=1) }}">
                            <i class="fas fa-plus mr-1"></i> Th√™m th√¥ng tin
                        </a>
                        {% endif %}

                    </div>

                </div>

                <div class="sum-row">
                    <span>S·ªë l∆∞·ª£ng m√≥n:</span>
                    <strong id="itemCount">0</strong>
                </div>

                <div class="sum-row">
                    <span>Ti·ªÅn h√†ng: </span>
                    <strong id="subTotal">0</strong>
                </div>

                <div class="sum-row">
      <span>
        Thu·∫ø (8%)
        <input type="checkbox" checked id="taxCheck" onchange="renderCart()">
      </span>
                    <span id="taxValue">0</span>
                </div>

              <!-- form r·ªùi: kh√¥ng ph√° c√°c form kh√°c -->
<form id="serviceFeeForm" method="post" action="{{ url_for('pos_set_service_fee') }}" style="display:none;"></form>

<div class="sum-row">
  <span class="fee-left">
    <span>Ph√≠ ph·ª•c v·ª•:</span>
    <input
      id="serviceFee"
      type="number"
      name="service_percent"
      form="serviceFeeForm"
      class="fee-input"
      min="0"
      max="100"
      step="1"
      value="{{ session.get('pos_service_percent', 0) }}"
      oninput="this.value = String(this.value).replace(/[^0-9]/g,''); renderCart();"
      onkeydown="if(event.key==='Enter'){ document.getElementById('serviceFeeForm').submit(); }"
    />
    <span>%</span>
  </span>

  <span id="serviceValue" class="sum-money">0</span>
</div>



                <div class="sum-total">
                    <div class="label">T·ªîNG THANH TO√ÅN:</div>
                    <div class="value" id="finalTotal">0</div>
                </div>
            </div>

            <!-- Actions (LU√îN N·∫∞M D∆Ø·ªöI C√ôNG) -->
            <div class="inv-actions mt-auto">
                <div class="row no-gutters">
                    <div class="col-4 pr-1">
                        <form method="post" action="{{ url_for('pos_cart_clear') }}">
                            <button type="submit" class="btn btn-outline-secondary btn-soft w-100">
                                <i class="fas fa-times mr-1"></i> H·ªßy
                            </button>
                        </form>
                    </div>

                    <div class="col-4 px-1">
                        <form action="{{ url_for('pos_print_temp') }}" method="get" target="_blank" class="w-100">
                            <button type="submit" class="btn btn-light btn-soft w-100 border">
                                <i class="fas fa-print mr-1"></i> In t·∫°m
                            </button>
                        </form>


                    </div>

                    <div class="col-4 pl-1">
                        <form method="post" action="{{ url_for('pos_pay') }}" class="m-0">
                            <input type="hidden" name="page" value="{{ page }}">
                            <button type="submit" class="btn-pay">
                                <i class="fas fa-cash-register mr-1"></i> Thanh to√°n
                            </button>
                        </form>
                    </div>
                </div>
            </div>

        </div>


    </div>
</div>

<script>
    // ===== cart ƒë∆∞·ª£c inject t·ª´ server pos_cart =====
    let cart = {};
    {% if pos_cart %}
      {% for key, it in pos_cart.items() %}
        cart[{{ key|tojson }}] = {
          name: {{ it.name|tojson }},
          price: {{ it.price|float }},
          qty: {{ it.quantity|int }},
          options: {{ (it.options or {})|tojson }}
        };
      {% endfor %}
    {% endif %}

    let currentOrderType = 'TAI_QUAN';

    function formatMoney(amount) {
      return (amount || 0).toLocaleString('vi-VN');
    }

    // ===== Layout helpers (√≠t JS) =====
    function showCartIfNeeded() {
      const hasCart = Object.keys(cart).length > 0;
      const hasModal = {{ 'true' if modal_ctx else 'false' }};
      const layout = document.getElementById('mainLayout');

      if (hasCart || hasModal) {
        layout.classList.add('layout-split');
        layout.classList.remove('layout-full');
      } else {
        layout.classList.add('layout-full');
        layout.classList.remove('layout-split');
      }
    }

    function renderCart() {
  const tbody = document.getElementById('cartTableBody');
  if (!tbody) return;

  tbody.innerHTML = '';
  let subTotal = 0;
  let itemCount = 0;

  for (let [id, item] of Object.entries(cart)) {
    const qty = item.qty || 0;
    const price = item.price || 0;
    const total = price * qty;

    subTotal += total;
    itemCount += qty;


    let optHtml = '';
    if (item.options) {
      if (Array.isArray(item.options.desc) && item.options.desc.length) {
        optHtml = `
          <div class="text-muted" style="font-size:12px;line-height:1.2;margin-top:2px;">
            ${item.options.desc.join('<br>')}
          </div>
        `;
      } else {
        const parts = [];
        if (item.options.size) parts.push(`Size: ${item.options.size}`);
        if (item.options.duong) parts.push(`ƒê∆∞·ªùng: ${item.options.duong}%`);
        if (item.options.da) parts.push(`ƒê√°: ${item.options.da}%`);
        if (Array.isArray(item.options.topping) && item.options.topping.length) {
          parts.push(`Topping: ${item.options.topping.join(', ')}`);
        }
        if (item.options.note && String(item.options.note).trim()) {
          parts.push(`Ghi ch√∫: ${String(item.options.note).trim()}`);
        }
        if (parts.length) {
          optHtml = `
            <div class="text-muted" style="font-size:12px;line-height:1.2;margin-top:2px;">
              ${parts.join('<br>')}
            </div>
          `;
        }
      }
    }

    const row = `
      <tr>
        <td>
          <div class="font-weight-bold">${item.name}</div>
          ${optHtml}
        </td>
        <td>
          <button class="btn-qty" onclick="changeQty('${id}', -1)">-</button>
          <span class="mx-1 font-weight-bold">${qty}</span>
          <button class="btn-qty" onclick="changeQty('${id}', 1)">+</button>
        </td>
        <td class="text-right font-weight-bold">
          ${formatMoney(total)}
        </td>
        <td class="text-center text-danger" style="cursor:pointer" onclick="removeItem('${id}')">
          <i class="fas fa-times"></i>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML('beforeend', row);
  }

  // ===== T√çNH TI·ªÄN =====
  const tax = document.getElementById('taxCheck')?.checked ? subTotal * 0.08 : 0;
  let servicePercent = parseFloat(document.getElementById('serviceFee')?.value) || 0;
servicePercent = Math.max(0, Math.min(100, servicePercent));

  const service = subTotal * (servicePercent / 100);
  const finalTotal = subTotal + tax + service;

  // ===== UPDATE UI =====
  if (document.getElementById('itemCount')) {
    document.getElementById('itemCount').innerText = itemCount;
  }
  document.getElementById('subTotal').innerText = formatMoney(subTotal);
  document.getElementById('taxValue').innerText = formatMoney(tax);
  if (document.getElementById('serviceValue')) {
  document.getElementById('serviceValue').innerText = formatMoney(service);
}
  document.getElementById('finalTotal').innerText = formatMoney(finalTotal);

  // ‚úÖ quy·∫øt ƒë·ªãnh c√≥ show gi·ªè hay kh√¥ng
  showCartIfNeeded();
}


    // ===== C√°c h√†m c≈© (gi·ªØ ƒë·ªÉ b·∫°n d√πng) =====
    function changeQty(id, delta) {
  const f = document.createElement('form');
  f.method = 'POST';

  if (delta > 0) f.action = `/pos/cart/inc/${encodeURIComponent(id)}`;
  else f.action = `/pos/cart/dec/${encodeURIComponent(id)}`;

  const inp = document.createElement('input');
  inp.type = 'hidden';
  inp.name = 'page';
  inp.value = '{{ page }}';
  f.appendChild(inp);

  document.body.appendChild(f);
  f.submit();
}


    function removeItem(id) {
  const f = document.createElement('form');
  f.method = 'POST';
  f.action = `/pos/cart/remove/${encodeURIComponent(id)}`;

  const inp = document.createElement('input');
  inp.type = 'hidden';
  inp.name = 'page';
  inp.value = '{{ page }}';
  f.appendChild(inp);

  document.body.appendChild(f);
  f.submit();
}

    function cancelOrder() {
      cart = {};
      renderCart(); // renderCart s·∫Ω t·ª± hide gi·ªè
    }

    function setOrderType(type, btnElement) {
      currentOrderType = type;
      document.querySelectorAll('.seg-btn').forEach(b => b.classList.remove('active'));
      btnElement.classList.add('active');
    }

    function payOrder() {
      if (Object.keys(cart).length === 0) return alert('Ch∆∞a ch·ªçn m√≥n!');
      alert(`Thanh to√°n th√†nh c√¥ng ${document.getElementById('finalTotal').innerText} VNƒê\nLo·∫°i: ${currentOrderType}`);
      cancelOrder();
    }

    // ‚úÖ Khi load trang: render gi·ªè + t·ª± quy·∫øt ƒë·ªãnh hi·ªán/·∫©n
    renderCart();
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

{% if modal_ctx %}
{% set mon = modal_ctx.mon %}
{% set form = modal_ctx.form %}
{% set errors = modal_ctx.errors %}
{% set unit_price = modal_ctx.unit_price %}
{% set total_price = modal_ctx.total_price %}
{% set desc_list = modal_ctx.desc_list %}
{% set SIZE_OPTS = modal_ctx.SIZE_OPTS %}
{% set SUGAR_OPTS = modal_ctx.SUGAR_OPTS %}
{% set ICE_OPTS = modal_ctx.ICE_OPTS %}
{% set TOPPING_OPTS = modal_ctx.TOPPING_OPTS %}
{% set edit_key = modal_ctx.edit_key %}
{% set ui_mode = modal_ctx.ui_mode %}
{% set close_url = modal_ctx.close_url %}
{% set form_action = modal_ctx.form_action %}

{% include "_drink_modal_body.html" %}
{% endif %}
{% include "layout/_flash_modal.html" %}
{# ===== MODAL KH√ÅCH H√ÄNG (server-side show) ===== #}
{% set open_customer_modal = request.args.get('customer_modal') %}
{% set open_pay_confirm = request.args.get('pay_confirm') %}

{% if open_customer_modal %}
<div class="modal-backdrop fade show"></div>
{% endif %}

<div class="modal fade {% if open_customer_modal %}show{% endif %}" id="customerModal"
     tabindex="-1" role="dialog"
     style="{% if open_customer_modal %}display:block;{% else %}display:none;{% endif %}">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="border-radius:14px;">
            <div class="modal-header">
                <h5 class="modal-title">Th√™m th√¥ng tin kh√°ch h√†ng</h5>
                <a class="close" aria-label="Close"
                   href="{{ url_for('pos_page', page=page) }}">
                    <span aria-hidden="true">&times;</span>
                </a>
            </div>

            <form method="post" action="{{ url_for('pos_customer_save') }}">
                <div class="modal-body">
                    {% set cust = session.get('pos_customer') or {} %}

                    <div class="form-group">
                        <label>T√™n kh√°ch h√†ng</label>
                        <input type="text" class="form-control" name="customer_name"
                               value="{{ cust.get('name','') }}" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
                    </div>

                    <div class="form-group mb-0">
                        <label>S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control"
                               name="customer_phone"
                               value="{{ cust.get('phone','') }}"
                               placeholder="V√≠ d·ª•: 0901234567"
                               inputmode="numeric"
                               pattern="[0-9]*"
                               maxlength="10"
                               oninput="this.value=this.value.replace(/[^0-9]/g,'');"
                               required>


                        {% if session.get('customer_err') %}
                        <div class="text-danger mt-2" style="font-size:13px;">
                            {{ session.pop('customer_err') }}
                        </div>
                        {% else %}
                        <small class="text-muted">SDT b·∫Øt bu·ªôc ƒë·ªÉ thanh to√°n</small>
                        {% endif %}
                    </div>

                    <input type="hidden" name="page" value="{{ page }}">
                </div>

                <div class="modal-footer">
                    <a class="btn btn-light" href="{{ url_for('pos_page', page=page) }}">H·ªßy</a>
                    <button type="submit" class="btn btn-success">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% if open_pay_confirm %}
<div class="modal-backdrop fade show"></div>
<div class="modal fade show" tabindex="-1" role="dialog" style="display:block;">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content" style="border-radius:14px;">
            <div class="modal-header">
                <h5 class="modal-title">Thi·∫øu th√¥ng tin kh√°ch h√†ng</h5>
                <a class="close" aria-label="Close" href="{{ url_for('pos_page', page=page) }}">
                    <span aria-hidden="true">&times;</span>
                </a>
            </div>
            <div class="modal-body">
                Ch∆∞a c√≥ <b>s·ªë ƒëi·ªán tho·∫°i</b>. B·∫°n c√≥ mu·ªën th√™m ƒë·ªÉ ti·∫øp t·ª•c thanh to√°n kh√¥ng?
            </div>
            <div class="modal-footer">
                <a class="btn btn-light" href="{{ url_for('pos_page', page=page) }}">ƒê·ªÉ sau</a>
                <a class="btn btn-success"
                   href="{{ url_for('pos_page', page=page, customer_modal=1) }}">
                    Th√™m SDT
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

</body>
</html>