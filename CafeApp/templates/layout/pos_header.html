<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}POS - Cafe Vip Pro{% endblock %}</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; overflow-x: hidden; }

    /* HEADER */

    .pos-header{
    pointer-events: auto;

  background-color:#28a745;
  color:white;
  padding:0 15px;
  height:50px;
  display:flex;
  align-items:center;
  justify-content:space-between;

  position: fixed;   /* QUAN TR·ªåNG */
  top: 0;
  left: 0;
  right: 0;
  z-index: 999999;   /* QUAN TR·ªåNG */
}
    .header-logo { font-weight: bold; font-size: 20px; margin-right: 20px; display: flex; align-items: center; }
    .header-btn { color: white; background: transparent; border: none; padding: 5px 15px; font-weight: 600; font-size: 14px; }
    .header-btn:hover, .header-btn.active { background-color: rgba(255,255,255,0.2); border-radius: 4px;}
    .header-icon { font-size: 18px; margin-left: 15px; cursor: pointer; }

    .page-wrap{
  height: 100vh;
  overflow-y: auto;
  padding: 50px 16px 16px 16px; /* ch·ª´a ƒë√∫ng chi·ªÅu cao header */
  box-sizing: border-box;
}

/* b·ªè margin-top c·ªßa block ƒë·∫ßu ƒë·ªÉ kh√¥ng t·∫°o ‚Äúkho·∫£ng h·ªü‚Äù */
.page-wrap > :first-child{
  margin-top: 0 !important;
}



    .card-soft { background: #fff; border: 1px solid #e9ecef; border-radius: 8px; }

    /* ===== NOTIFICATION BELL (UI only) ===== */
    .noti-wrap { position: relative; margin-left: 15px; }
    .noti-badge{
      position:absolute; top:-6px; right:-6px;
      background:#dc3545; color:#fff;
      border-radius:999px; padding:1px 6px;
      font-size:11px; font-weight:700;
      display:none;
      line-height: 1.2;
    }
    .noti-menu { width: 360px; max-height: 420px; overflow: auto; }
    .noti-item { white-space: normal; font-size: 13px; }
    .noti-time { font-size: 11px; opacity: .8; margin-top: 4px; }
  </style>

  {% block head_extra %}{% endblock %}
</head>
<body>

  <!-- POS HEADER (t√°ch t·ª´ pos.html c·ªßa b·∫°n) -->
  <div class="pos-header">
    <div class="d-flex align-items-center">
      <div class="header-logo">
        <i class="fas fa-leaf mr-2"></i> CAFE VIP PRO
      </div>

      <a class="header-btn {% if active_page=='pos' %}active{% endif %}" href="{{ url_for('pos_page') }}">
        <i class="fas fa-utensils"></i> Order
      </a>
      <button class="header-btn" type="button">
        <i class="fas fa-truck"></i> S·ªë giao h√†ng
      </button>
    </div>

    <div class="d-flex align-items-center">
      <span class="mr-3"><i class="fas fa-user"></i> {{ current_user.name }}</span>
      <a href="{{ request.full_path }}"
   class="header-icon"
   title="T·∫£i l·∫°i"
   style="color: inherit; text-decoration: none;">
  <i class="fas fa-sync"></i>
</a>


      <i class="fas fa-cloud header-icon" title="ƒê√°m m√¢y"></i>

      <!-- üîî BELL: JS ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã th√¥ng b√°o -->
      <div class="dropdown noti-wrap">
        <i class="fas fa-bell header-icon dropdown-toggle"
           id="notiBell"
           data-toggle="dropdown"
           aria-haspopup="true"
           aria-expanded="false"
           style="cursor:pointer"></i>

        <span class="noti-badge" id="notiBadge">0</span>

        <div class="dropdown-menu dropdown-menu-right noti-menu" aria-labelledby="notiBell">
          <div class="px-3 py-2 font-weight-bold">Th√¥ng b√°o</div>
          <div class="dropdown-divider"></div>

          <div id="notiList" class="px-2">
            <div class="text-muted px-2 py-2">Ch∆∞a c√≥ th√¥ng b√°o.</div>
          </div>
        </div>
      </div>

      <!-- MENU ‚ò∞ -->
      <div class="dropdown">
        <i class="fas fa-bars header-icon dropdown-toggle"
           id="posMenu"
           data-toggle="dropdown"
           aria-haspopup="true"
           aria-expanded="false"
           style="cursor:pointer"></i>

        <div class="dropdown-menu dropdown-menu-right">
          <a class="dropdown-item" href="{{ url_for('order_history') }}">
            <i class="fas fa-receipt mr-2"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng
          </a>

          <div class="dropdown-divider"></div>

          <a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
            <i class="fas fa-sign-out-alt mr-2"></i> ƒêƒÉng xu·∫•t
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="page-wrap">
    {% block content %}{% endblock %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

  {% block scripts %}
  <script>
    // JS t·ªëi thi·ªÉu: ch·ªâ h·ªèi server ƒë·ªÉ hi·ªán badge + list
    async function fetchNoti(){
      try{
        const res = await fetch("{{ url_for('pos_api_notifications') }}", { cache: "no-store" });
        const data = await res.json();
        if(!data.ok) return;

        const badge = document.getElementById("notiBadge");
        const list  = document.getElementById("notiList");

        // badge
        if(data.count > 0){
          badge.style.display = "inline-block";
          badge.textContent = data.count > 99 ? "99+" : String(data.count);
        } else {
          badge.style.display = "none";
        }

        // list: link click -> backend open notification -> redirect bill b·∫øp
        if(!data.items || data.items.length === 0){
          list.innerHTML = '<div class="text-muted px-2 py-2">Ch∆∞a c√≥ th√¥ng b√°o.</div>';
          return;
        }

        list.innerHTML = data.items.map(it => {
          const href = "{{ url_for('pos_open_notification', noti_id=0) }}".replace("0", it.id);
          const time = it.time || it.created_at || "";
          return `
            <a class="dropdown-item noti-item" href="${href}">
              <div>${it.message}</div>
              <div class="noti-time">${time}</div>
            </a>
          `;
        }).join("");
      }catch(e){}
    }

    fetchNoti();
    setInterval(fetchNoti, 3000);
  </script>
  {% endblock %}
</body>
</html>
