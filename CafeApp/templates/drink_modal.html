{% extends "layout/base.html" %}
{% block title %}Thêm vào giỏ{% endblock %}

{% block content %}
<style>
    .modal-backdrop-fake{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.35);
      z-index: 1040;
    }
    .modal-card-fake{
      position: fixed;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      width: min(560px, 94vw);
      max-height: 88vh;
      overflow: auto;
      z-index: 1050;
      border-radius: 16px;
    }
    .pill input{ display:none; }
    .pill{ cursor:pointer; }
    .pill input:checked + span{
      background: #0d6efd;
      color: #fff;
      border-color: #0d6efd;
    }
</style>

<div class="modal-backdrop-fake"></div>

<div class="bg-white shadow modal-card-fake p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <a href="{{ url_for('menu') }}" class="btn btn-sm btn-light">×</a>
        <div class="fw-semibold">Thêm vào giỏ</div>
        <div style="width:34px;"></div>
    </div>

    <div class="mb-2">
        <div class="fw-bold fs-4">{{ mon.name }}</div>
        <div class="text-danger fw-semibold">{{ "{:,.0f}".format(mon.gia) }}đ</div>
        <div class="text-muted">{{ mon.moTa or "" }}</div>
    </div>

    <form method="post" action="{{ url_for('drink_config', mon_id=mon.id) }}">
        {% if edit_key %}
        <input type="hidden" name="edit_key" value="{{ edit_key or '' }}">
        {% endif %}

        {# đổi tên để không đụng với button name="action" #}
        <input type="hidden" name="mode" value="recalc">

        <!-- SIZE -->
        <div class="mt-3">
            <div class="fw-semibold">Chọn size</div>
            <div class="d-flex gap-2 flex-wrap mt-2">
                {% for code,label,delta in SIZE_OPTS %}
                <label class="pill">
                    <input type="radio" name="size" value="{{ code }}"
                           {% if form.size==code %}checked{% endif %}
                           onchange="this.form.submit()">
                    <span class="btn btn-outline-secondary rounded-pill">
            {{ label }}{% if delta>0 %} (+{{ "{:,.0f}".format(delta) }}đ){% endif %}
          </span>
                </label>
                {% endfor %}
            </div>
            <div class="small text-muted mt-1">Mặc định: Size S</div>
        </div>

        <!-- ĐÁ -->
        <div class="mt-3">
            <div class="fw-semibold">Lượng đá</div>
            <div class="d-flex gap-2 flex-wrap mt-2">
                {% for v,label in ICE_OPTS %}
                <label class="pill">
                    <input type="radio" name="da" value="{{ v }}"
                           {% if form.da==v %}checked{% endif %}
                           onchange="this.form.submit()">
                    <span class="btn btn-outline-secondary rounded-pill">{{ label }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="small text-muted mt-1">Mặc định: 70% đá</div>
        </div>

        <!-- ĐƯỜNG -->
        <div class="mt-3">
            <div class="fw-semibold">Độ ngọt</div>
            <div class="d-flex gap-2 flex-wrap mt-2">
                {% for v,label in SUGAR_OPTS %}
                <label class="pill">
                    <input type="radio" name="duong" value="{{ v }}"
                           {% if form.duong==v %}checked{% endif %}
                           onchange="this.form.submit()">
                    <span class="btn btn-outline-secondary rounded-pill">{{ label }}</span>
                </label>
                {% endfor %}
            </div>
            <div class="small text-muted mt-1">Mặc định: 70% đường</div>
        </div>

        <!-- TOPPING -->
        <div class="mt-3">
            <div class="fw-semibold">Topping</div>
            <div class="d-flex gap-2 flex-wrap mt-2">
                {% for code,label,price in TOPPING_OPTS %}
                <label class="pill">
                    <input type="checkbox" name="topping" value="{{ code }}"
                           {% if code in form.topping %}checked{% endif %}
                           onchange="this.form.submit()">
                    <span class="btn btn-outline-secondary rounded-pill">
            {{ label }} (+{{ "{:,.0f}".format(price) }}đ)
          </span>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- GHI CHÚ -->
        <div class="mt-3">
            <div class="fw-semibold">Ghi chú</div>
            <textarea name="note" class="form-control" rows="2"
                      placeholder="Ví dụ: ít đá, không béo...">{{ form.note }}</textarea>
        </div>

        <!-- SỐ LƯỢNG -->
        <div class="mt-3">
            <div class="fw-semibold">Số lượng</div>
            {% if errors.get('quantity') %}
            <div class="text-danger small">{{ errors.get('quantity') }}</div>
            {% endif %}
            <input name="quantity" class="form-control" value="{{ form.quantity }}">
        </div>

        <!-- NÚT THÊM GIỎ (hiện total) -->
        <div class="mt-4">
            <button name="action" value="add" type="submit"
                    class="btn btn-danger w-100 fw-bold rounded-pill">
                THÊM VÀO GIỎ - {{ "{:,.0f}".format(total_price) }}đ
            </button>
        </div>
    </form>
</div>
{% endblock %}
