{% extends "layout/pos_header.html" %}
{% block title %}Lịch sử đơn hàng - POS{% endblock %}

{% block content %}
<div class="card-soft p-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0"><i class="fas fa-receipt mr-2"></i>Lịch sử đơn hàng</h5>

    <form class="form-inline" method="get">
      <input name="q" value="{{ request.args.get('q','') }}"
             class="form-control form-control-sm mr-2"
             placeholder="Tìm mã hóa đơn / SĐT...">
      <button class="btn btn-sm btn-outline-success" type="submit">
        <i class="fas fa-search"></i>
      </button>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-hover table-sm mb-0">
      <thead class="thead-light">
        <tr>
          <th>Mã hóa đơn</th>
          <th>Loại hóa đơn</th>
          <th>Tên khách hàng</th>
          <th>Số điện thoại</th>
          <th>Ngày thanh toán</th>
          <th class="text-right">Tổng tiền</th>
          <th class="text-center">Số món</th>
          <th class="text-center">Chi tiết</th>
        </tr>
      </thead>

      <tbody>
      {% if orders and orders|length > 0 %}
        {# ====== VÒNG 1: CHỈ VẼ 1 HÀNG / 1 HÓA ĐƠN ====== #}
        {% for o in orders %}
          <tr>
            <td class="font-weight-bold">{{ o.ma }}</td>

            <td>
              {% if o.order_type == "TAI_QUAN" %}
                <span class="badge badge-success">Tại quán</span>
              {% elif o.order_type == "MANG_DI" %}
                <span class="badge badge-primary">Mang đi</span>
              {% elif o.order_type == "ONLINE" %}
                <span class="badge badge-warning">Online</span>
              {% else %}
                <span class="badge badge-secondary">{{ o.order_type }}</span>
              {% endif %}
            </td>

            <td>{{ o.khach_ten }}</td>
            <td>{{ o.khach_sdt }}</td>
            <td>{{ o.paid_at.strftime("%d/%m/%Y %H:%M:%S") if o.paid_at else "" }}</td>
            <td class="text-right">{{ "{:,.0f}".format(o.total) }}</td>
            <td class="text-center">{{ o.item_count }}</td>

            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary"
                      data-toggle="modal"
                      data-target="#modal-{{ o.id }}">
                Xem
              </button>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="8" class="text-center text-muted py-4">Chưa có đơn hàng nào.</td>
        </tr>
      {% endif %}
      </tbody>
    </table>
    {% if pagination and pagination.pages > 1 %}
<nav class="mt-3">
  <ul class="pagination pagination-sm mb-0">

    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('order_history', page=pagination.prev_num, q=q) }}">‹</a>
    </li>

    {% for p in range(1, pagination.pages + 1) %}
      <li class="page-item {% if p == pagination.page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('order_history', page=p, q=q) }}">{{ p }}</a>
      </li>
    {% endfor %}

    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('order_history', page=pagination.next_num, q=q) }}">›</a>
    </li>

  </ul>
</nav>
{% endif %}
  </div>
</div>

{# ====== VÒNG 2: MODAL (ĐỂ NGOÀI TABLE) ====== #}
{% if orders and orders|length > 0 %}
  {% for o in orders %}
    <div class="modal fade" id="modal-{{ o.id }}" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Chi tiết hóa đơn {{ o.ma }}</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div><b>Khách:</b> {{ o.khach_ten }}</div>
                <div><b>SĐT:</b> {{ o.khach_sdt }}</div>
                <div><b>Loại:</b> {{ o.order_type }}</div>
              </div>
              <div class="col-md-6 text-md-right">
                <div><b>Thanh toán:</b> {{ o.paid_at.strftime("%d/%m/%Y %H:%M:%S") if o.paid_at else "" }}</div>
                <div><b>Tổng tiền:</b> {{ "{:,.0f}".format(o.total) }} VNĐ</div>
              </div>
            </div>

            <hr>

            <div class="table-responsive">
              <table class="table table-sm table-striped mb-0">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Tên món</th>
                    <th class="text-center">SL</th>
                    <th class="text-right">Đơn giá</th>
                    <th class="text-right">Thành tiền</th>
                  </tr>
                </thead>
                <tbody>
                  {% for it in o["items"] %}
                    <tr>
                      <td>{{ loop.index }}</td>
                      <td>{{ it.name }}</td>
                      <td class="text-center">{{ it.qty }}</td>
                      <td class="text-right">{{ "{:,.0f}".format(it.price) }}</td>
                      <td class="text-right">{{ "{:,.0f}".format(it.price * it.qty) }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
          </div>

        </div>
      </div>
    </div>
  {% endfor %}
{% endif %}
{% endblock %}
